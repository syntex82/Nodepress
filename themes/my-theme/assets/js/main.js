(function(){
  'use strict';
  document.addEventListener('DOMContentLoaded',function(){initUserMenu();updateCartCount();initAddToCart();});
  function initUserMenu(){var b=document.getElementById('userMenuBtn'),d=document.getElementById('userDropdown');if(b&&d){b.addEventListener('click',function(e){e.stopPropagation();d.classList.toggle('active');});document.addEventListener('click',function(){d.classList.remove('active');});}var l=document.getElementById('logoutBtn');if(l){l.addEventListener('click',function(){localStorage.removeItem('access_token');window.location.href='/logout';});}}
  async function updateCartCount(){var c=document.getElementById('cartCount');if(!c)return;try{var r=await fetch('/api/shop/cart',{credentials:'include',headers:getAuthHeaders()});if(!r.ok){c.style.display='none';return;}var cart=await r.json();var count=cart.items?.reduce((s,i)=>s+i.quantity,0)||0;if(count>0){c.textContent=count;c.style.display='flex';}else{c.style.display='none';}}catch(e){c.style.display='none';}}
  function initAddToCart(){document.querySelectorAll('[data-add-product]').forEach(b=>{b.addEventListener('click',async function(){await addToCart('product',this.dataset.addProduct);});});document.querySelectorAll('[data-add-course]').forEach(b=>{b.addEventListener('click',async function(){await addToCart('course',this.dataset.addCourse);});});document.querySelectorAll('[data-enroll-course]').forEach(b=>{b.addEventListener('click',async function(){await enrollFreeCourse(this.dataset.enrollCourse);});});}
  async function addToCart(type,id){try{var endpoint=type==='course'?'/api/shop/cart/add-course':'/api/shop/cart/add';var body=type==='course'?{courseId:id}:{productId:id,quantity:1};var r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json',...getAuthHeaders()},body:JSON.stringify(body),credentials:'include'});if(r.ok){updateCartCount();showNotification('Added to cart!','success');}else{var e=await r.json();showNotification(e.message||'Failed to add to cart','error');}}catch(e){showNotification('Failed to add to cart','error');}}
  async function enrollFreeCourse(courseId){try{var r=await fetch('/api/lms/courses/'+courseId+'/enroll',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({}),credentials:'include'});if(r.ok){showNotification('Successfully enrolled!','success');setTimeout(function(){window.location.href='/learn/'+courseId;},1500);}else if(r.status===401){showNotification('Please log in to enroll','error');setTimeout(function(){window.location.href='/login?redirect='+encodeURIComponent(window.location.pathname);},1500);}else{var e=await r.json();showNotification(e.message||'Failed to enroll','error');}}catch(e){showNotification('Failed to enroll','error');}}
  function showNotification(msg,type){var n=document.createElement('div');n.className='notification notification-'+type;n.textContent=msg;n.style.cssText='position:fixed;top:80px;right:20px;padding:1rem 1.5rem;background:'+(type==='success'?'var(--color-success)':type==='error'?'var(--color-error)':'var(--color-primary)')+';color:white;border-radius:8px;z-index:9999;';document.body.appendChild(n);setTimeout(()=>n.remove(),3000);}
  function getAuthHeaders(){var t=localStorage.getItem('access_token');return t?{'Authorization':'Bearer '+t}:{};}
  window.addToCart=addToCart;window.updateCartCount=updateCartCount;window.enrollFreeCourse=enrollFreeCourse;
})();